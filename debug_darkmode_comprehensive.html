<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Mode Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body[data-theme="dark"] {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .debug-panel {
            border: 2px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        body[data-theme="dark"] .debug-panel {
            border-color: #555;
            background-color: #2a2a2a;
        }
        
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        
        body[data-theme="dark"] .success { background-color: #1e4620; color: #d1e7dd; }
        body[data-theme="dark"] .error { background-color: #4a1e1e; color: #f8d7da; }
    </style>
</head>
<body>
    <h1>🌙 Dark Mode Debug Test</h1>
    
    <div class="debug-panel">
        <h2>Theme Toggle Button Test</h2>
        <button id="themeToggle" aria-label="Toggle dark mode">🌙</button>
        <button onclick="runDiagnostics()">🔍 Run Diagnostics</button>
        <button onclick="manualToggle()">🔧 Manual Toggle</button>
    </div>
    
    <div class="debug-panel">
        <h2>Debug Information</h2>
        <div id="debugInfo"></div>
    </div>
    
    <div class="debug-panel">
        <h2>Navigation Test</h2>
        <a href="index.html">🏠 Home</a> |
        <a href="kleine-probleme.html">📋 Kleine Probleme</a> |
        <a href="grosse-probleme.html">🏢 Große Probleme</a> |
        <a href="impressum.html">📄 Impressum</a>
    </div>

    <script>
        // Copy the exact Dark Mode code from script.js
        const THEME_KEY = 'stefan-spiess-theme';

        function initTheme() {
            console.log('🎯 initTheme() called');
            const savedTheme = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            console.log('💾 Saved theme:', savedTheme);
            console.log('🖥️ System prefers dark:', prefersDark);
            console.log('✅ Final theme:', theme);
            
            applyTheme(theme);
            updateToggleButton(theme);
        }

        function applyTheme(theme) {
            console.log('🎨 applyTheme() called with:', theme);
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.body.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.body.removeAttribute('data-theme');
            }
            localStorage.setItem(THEME_KEY, theme);
        }

        function updateToggleButton(theme) {
            console.log('🔄 updateToggleButton() called with:', theme);
            const toggleButton = document.getElementById('themeToggle');
            if (toggleButton) {
                if (theme === 'dark') {
                    toggleButton.textContent = '☀️';
                    toggleButton.setAttribute('aria-label', 'Switch to light mode');
                } else {
                    toggleButton.textContent = '🌙';
                    toggleButton.setAttribute('aria-label', 'Switch to dark mode');
                }
                console.log('✅ Button updated:', toggleButton.textContent);
            } else {
                console.error('❌ Toggle button not found!');
            }
        }

        function toggleTheme() {
            console.log('🔀 toggleTheme() called');
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            console.log('🔄 Current theme:', currentTheme, '→ New theme:', newTheme);
            
            applyTheme(newTheme);
            updateToggleButton(newTheme);
            
            updateDebugInfo();
        }

        function initThemeToggle() {
            console.log('🎮 initThemeToggle() called');
            const toggleButton = document.getElementById('themeToggle');
            if (toggleButton) {
                // Remove any existing event listeners
                toggleButton.removeEventListener('click', toggleTheme);
                
                // Add new event listener
                toggleButton.addEventListener('click', toggleTheme);
                
                // Keyboard support
                toggleButton.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleTheme();
                    }
                });
                
                console.log('✅ Event listeners attached');
            } else {
                console.error('❌ Toggle button not found during init!');
            }
        }

        function runDiagnostics() {
            const results = [];
            
            // Check button existence
            const button = document.getElementById('themeToggle');
            results.push({
                test: 'Button exists',
                result: !!button,
                details: button ? 'Found' : 'Not found'
            });
            
            // Check event listeners
            if (button) {
                const hasClickListener = button.onclick !== null || button.addEventListener;
                results.push({
                    test: 'Has click handler',
                    result: hasClickListener,
                    details: button.onclick ? 'onclick set' : 'addEventListener used'
                });
            }
            
            // Check localStorage
            const savedTheme = localStorage.getItem(THEME_KEY);
            results.push({
                test: 'LocalStorage theme',
                result: true,
                details: savedTheme || 'none'
            });
            
            // Check current theme
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            results.push({
                test: 'Current theme',
                result: true,
                details: currentTheme
            });
            
            displayResults(results);
        }
        
        function manualToggle() {
            console.log('🔧 Manual toggle triggered');
            toggleTheme();
        }
        
        function displayResults(results) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.innerHTML = results.map(r => 
                `<div class="test-result ${r.result ? 'success' : 'error'}">
                    ${r.result ? '✅' : '❌'} ${r.test}: ${r.details}
                </div>`
            ).join('');
        }
        
        function updateDebugInfo() {
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const savedTheme = localStorage.getItem(THEME_KEY);
            const button = document.getElementById('themeToggle');
            
            document.getElementById('debugInfo').innerHTML = `
                <div class="test-result success">Current theme: ${escapeHTML(currentTheme)}</div>
                <div class="test-result success">Saved theme: ${escapeHTML(savedTheme)}</div>
                <div class="test-result success">Button text: ${button ? escapeHTML(button.textContent) : 'N/A'}</div>
                <div class="test-result success">Last update: ${escapeHTML(new Date().toLocaleTimeString())}</div>
            `;
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded - initializing theme system');
            initTheme();
            initThemeToggle();
            updateDebugInfo();
        });
        
        // Also run immediately in case DOM is already loaded
        if (document.readyState === 'loading') {
            console.log('📋 DOM still loading, waiting...');
        } else {
            console.log('🚀 DOM already loaded - initializing immediately');
            initTheme();
            initThemeToggle();
            updateDebugInfo();
        }
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function (char) {
                const escapeMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return escapeMap[char] || char;
            });
        }
    </script>
</body>
</html>
